<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Esta√ß√£o Meteorol√≥gica - Itabuna, BA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f8fafc;
            min-height: 100vh;
        }
        .data-card {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #475569;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .data-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.2), 0 10px 10px -5px rgba(59, 130, 246, 0.1);
            border-color: #60a5fa;
        }
        .chart-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: linear-gradient(145deg, #374151 0%, #4b5563 100%);
            color: #e2e8f0;
            font-weight: 500;
            border: 1px solid #64748b;
            transition: all 0.2s ease;
        }
        .chart-btn.active, .chart-btn:hover {
            background: linear-gradient(145deg, #3b82f6 0%, #2563eb 100%);
            border-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .card-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        .weather-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #fbbf24;
            filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.3));
        }
        .status-indicator {
            background: linear-gradient(90deg, #10b981, #06d6a0);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        .temp-gradient {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .humidity-gradient {
            background: linear-gradient(135deg, #06b6d4, #0284c7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .pressure-gradient {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .altitude-gradient {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-100">
                <i class="fas fa-cloud-sun text-blue-400"></i> Esta√ß√£o Meteorol√≥gica
            </h1>
            <p class="text-lg text-slate-300 mt-2">üìç Itabuna, Bahia</p>
            <div class="mt-4 flex items-center justify-center space-x-2">
                <div class="w-3 h-3 status-indicator animate-pulse"></div>
                <span id="status-text" class="text-emerald-400 font-medium">Online</span>
                <span class="text-slate-400">‚Ä¢</span>
                <span id="last-update" class="text-slate-300">
                    <i class="fas fa-clock text-blue-400"></i> √öltima atualiza√ß√£o: --:--:--
                </span>
            </div>
        </header>

        <section class="mb-8">
            <h2 class="text-2xl font-bold text-slate-100 mb-4">Condi√ß√µes Atuais</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="data-card text-center">
                    <i class="fas fa-thermometer-half card-icon text-orange-400"></i>
                    <p class="text-lg font-medium text-slate-300">Temperatura</p>
                    <p id="temp-value" class="text-6xl font-bold temp-gradient my-4">--.- ¬∞C</p>
                </div>
                <div class="data-card text-center">
                    <i class="fas fa-tint card-icon text-cyan-400"></i>
                    <p class="text-lg font-medium text-slate-300">Umidade</p>
                    <p id="humidity-value" class="text-6xl font-bold humidity-gradient my-4">-- %</p>
                </div>
                <div class="data-card text-center">
                    <i class="fas fa-gauge-high card-icon text-violet-400"></i>
                    <p class="text-lg font-medium text-slate-300">Press√£o Atmosf√©rica</p>
                    <p id="pressure-value" class="text-6xl font-bold pressure-gradient my-4">---- hPa</p>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-2xl font-bold text-slate-100 mb-4">Status Clim√°tico</h2>
            <div class="data-card text-center">
                <i class="fas fa-sun weather-icon" id="weatherIcon"></i>
                <p class="text-2xl font-bold mb-3" id="weather-status">Condi√ß√µes Ideais</p>
                <p class="text-lg text-slate-300 mb-4">
                    <i class="fas fa-thermometer-half text-orange-400 mr-2"></i>
                    Temperatura atual: <span id="current-temp" class="font-bold">--¬∞C</span>
                </p>
                <div class="mt-4 bg-slate-700/30 rounded-lg p-4">
                    <div class="text-sm text-slate-400 mb-3">Classifica√ß√£o T√©rmica</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <div class="text-blue-400">
                            <i class="fas fa-icicles"></i> < 10¬∞C<br>
                            <span class="text-blue-300">Extremo</span>
                        </div>
                        <div class="text-sky-400">
                            <i class="fas fa-snowflake"></i> 10-18¬∞C<br>
                            <span class="text-sky-300">Frio</span>
                        </div>
                        <div class="text-emerald-400">
                            <i class="fas fa-sun"></i> 18-26¬∞C<br>
                            <span class="text-emerald-300">Ideal</span>
                        </div>
                        <div class="text-red-400">
                            <i class="fas fa-fire"></i> > 26¬∞C<br>
                            <span class="text-red-300">Quente</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>0¬∞C</span>
                            <span>50¬∞C</span>
                        </div>
                        <div class="h-3 bg-slate-600 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-500 via-green-400 via-yellow-400 to-red-500 rounded-full transition-all duration-500" id="temp-bar" style="width:50%;"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 p-3 rounded-lg" id="climate-recommendation">
                    <div class="text-sm font-medium mb-1">
                        <i class="fas fa-lightbulb text-yellow-400 mr-1"></i> Recomenda√ß√£o
                    </div>
                    <div class="text-sm" id="recommendation-text">
                        Temperatura agrad√°vel para atividades ao ar livre
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8 data-card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-100 mb-4 md:mb-0">Hist√≥rico das √öltimas Horas</h2>
                <div id="chart-controls" class="flex space-x-2">
                    <button class="chart-btn active" data-metric="temp">Temperatura</button>
                    <button class="chart-btn" data-metric="humidity">Umidade</button>
                    <button class="chart-btn" data-metric="pressure">Press√£o</button>
                </div>
            </div>
            <div id="chart"></div>
        </section>

        <section>
            <h2 class="text-2xl font-bold text-slate-100 mb-4">Informa√ß√µes Adicionais</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="data-card text-center">
                    <i class="fas fa-mountain card-icon text-emerald-400"></i>
                    <p class="text-lg font-medium text-slate-300">Altitude Estimada</p>
                    <p id="altitude-value" class="text-6xl font-bold altitude-gradient my-4">---- m</p>
                    <p class="text-slate-400">‚õ∞Ô∏è Baseada na press√£o atual</p>
                </div>
                <div class="data-card">
                    <h3 class="text-lg font-medium text-slate-300 mb-4">
                        <i class="fas fa-microchip text-blue-400 mr-2"></i>Detalhes dos Sensores
                    </h3>
                    <ul class="space-y-3 text-slate-300">
                        <li class="flex items-center">
                            <i class="fas fa-thermometer-half text-orange-400 w-5 mr-3"></i>
                            <strong>Press√£o/Temp:</strong>&nbsp;BMP280
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-tint text-cyan-400 w-5 mr-3"></i>
                            <strong>Umidade/Temp:</strong>&nbsp;AHT20
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-wifi text-blue-400 w-5 mr-3"></i>
                            <strong>Plataforma:</strong>&nbsp;Raspberry Pi Pico W
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 text-slate-400">
            <p>&copy; 2025 - Projeto de Esta√ß√£o Meteorol√≥gica</p>
        </footer>
    </div>

    <script>
        let currentMetric = 'temp';
        let chartData = {
            temp: Array(20).fill(0),
            humidity: Array(20).fill(0),
            pressure: Array(20).fill(0),
            categories: Array(20).fill(null).map(function(_, i) {
                var d = new Date();
                d.setSeconds(d.getSeconds() - (20 - i) * 5);
                return d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            })
        };
        let state = {maxLimit: 70, minLimit: 10};

        const chartOptions = {
            series: [{name: 'Temperatura', data: chartData.temp}],
            chart: {
                height: 350,
                type: 'area',
                toolbar: {show: false},
                zoom: {enabled: false},
                background: 'transparent',
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {speed: 1000}
                }
            },
            dataLabels: {enabled: false},
            stroke: {curve: 'smooth', width: 3},
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.1
                }
            },
            xaxis: {
                categories: chartData.categories,
                labels: {style: {colors: '#cbd5e1'}}
            },
            yaxis: {
                labels: {
                    style: {colors: '#cbd5e1'},
                    formatter: function(val) {
                        return val.toFixed(1);
                    }
                }
            },
            tooltip: {theme: 'dark', x: {format: 'HH:mm:ss'}},
            grid: {borderColor: '#475569', strokeDashArray: 3},
            colors: ['#f59e0b']
        };

        const chart = new ApexCharts(document.querySelector('#chart'), chartOptions);
        chart.render();

        function updateClimateStatus(temperature) {
            var weatherIcon = document.getElementById('weatherIcon');
            var weatherStatus = document.getElementById('weather-status');
            var currentTemp = document.getElementById('current-temp');
            var tempBar = document.getElementById('temp-bar');
            var recommendationDiv = document.getElementById('climate-recommendation');
            var recommendationText = document.getElementById('recommendation-text');

            currentTemp.textContent = temperature + '¬∞C';
            var tempPercentage = Math.max(0, Math.min(100, (temperature / 50) * 100));
            tempBar.style.width = tempPercentage + '%';
            weatherIcon.className = 'weather-icon';

            var recommendation = '';
            var bgClass = '';

            if (temperature < 10) {
                weatherIcon.classList.add('fas', 'fa-icicles');
                weatherIcon.style.color = '#3b82f6';
                weatherStatus.textContent = 'Extremamente Frio';
                weatherStatus.style.color = '#3b82f6';
                recommendation = 'Use roupas muito quentes. Evite exposi√ß√£o prolongada ao ar livre.';
                bgClass = 'bg-blue-900/20 border border-blue-700';
            } else if (temperature >= 10 && temperature < 18) {
                weatherIcon.classList.add('fas', 'fa-snowflake');
                weatherIcon.style.color = '#60a5fa';
                weatherStatus.textContent = 'Frio';
                weatherStatus.style.color = '#60a5fa';
                recommendation = 'Use roupas quentes. Ideal para atividades internas.';
                bgClass = 'bg-blue-900/20 border border-blue-600';
            } else if (temperature >= 18 && temperature <= 22) {
                weatherIcon.classList.add('fas', 'fa-cloud-sun');
                weatherIcon.style.color = '#06d6a0';
                weatherStatus.textContent = 'Fresco';
                weatherStatus.style.color = '#06d6a0';
                recommendation = 'Temperatura agrad√°vel. Use roupas leves ou casaco fino.';
                bgClass = 'bg-emerald-900/20 border border-emerald-600';
            } else if (temperature > 22 && temperature <= 26) {
                weatherIcon.classList.add('fas', 'fa-sun');
                weatherIcon.style.color = '#fbbf24';
                weatherStatus.textContent = 'Condi√ß√µes Ideais';
                weatherStatus.style.color = '#10b981';
                recommendation = 'Perfeito para qualquer atividade ao ar livre!';
                bgClass = 'bg-green-900/20 border border-green-600';
            } else if (temperature > 26 && temperature <= 30) {
                weatherIcon.classList.add('fas', 'fa-temperature-high');
                weatherIcon.style.color = '#f97316';
                weatherStatus.textContent = 'Quente';
                weatherStatus.style.color = '#f97316';
                recommendation = 'Use roupas leves e mantenha-se hidratado.';
                bgClass = 'bg-orange-900/20 border border-orange-600';
            } else if (temperature > 30 && temperature <= 35) {
                weatherIcon.classList.add('fas', 'fa-fire');
                weatherIcon.style.color = '#ef4444';
                weatherStatus.textContent = 'Muito Quente';
                weatherStatus.style.color = '#ef4444';
                recommendation = 'Evite exposi√ß√£o ao sol. Beba muita √°gua e procure sombra.';
                bgClass = 'bg-red-900/20 border border-red-600';
            } else {
                weatherIcon.classList.add('fas', 'fa-fire-flame-curved');
                weatherIcon.style.color = '#dc2626';
                weatherStatus.textContent = 'Calor Extremo';
                weatherStatus.style.color = '#dc2626';
                recommendation = 'ATEN√á√ÉO: Evite atividades ao ar livre. Risco √† sa√∫de!';
                bgClass = 'bg-red-900/30 border border-red-500';
            }

            recommendationText.textContent = recommendation;
            recommendationDiv.className = 'mt-4 p-3 rounded-lg ' + bgClass;
        }


        async function updateData() {
            try {
                const r = await fetch('/api/weather');  // Requisi√ß√£o para o servidor
                const d = await r.json();          // Converte resposta para JSON

                // Atualiza os dados locais
                const newTemp = d.temperature;
                const newHumidity = d.humidity;
                const newPressure = d.pressure;
                const newAltitude = d.altitude;

                // Atualiza limites se mudaram no servidor
                if (d.maxTemperature !== undefined) {
                    state.maxLimit = d.maxTemperature;
                }
                if (d.minTemperature !== undefined) {
                    state.minLimit = d.minTemperature;
                }

                // 2. Atualiza os cards de Condi√ß√µes Atuais
                document.getElementById('temp-value').textContent = `${newTemp} ¬∞C`;
                document.getElementById('humidity-value').textContent = `${Math.round(newHumidity)} %`;
                document.getElementById('pressure-value').textContent = `${Math.round(newPressure)} hPa`;
                document.getElementById('altitude-value').textContent = `${Math.round(altitude)} m`;

                //updateClimateStatus(newTemp);

                // 4. Atualiza o timestamp
                const now = new Date();
                document.getElementById('last-update').textContent = `√öltima atualiza√ß√£o: ${now.toLocaleTimeString('pt-BR')}`;

                // 5. Atualiza os dados do gr√°fico
                chartData.temp.push(newTemp);
                chartData.humidity.push(newHumidity);
                chartData.pressure.push(newPressure);
                chartData.categories.push(now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));

                // Mant√©m o gr√°fico com apenas 20 pontos de dados (efeito de rolagem)
                if (chartData.temp.length > 20) {
                    chartData.temp.shift();
                    chartData.humidity.shift();
                    chartData.pressure.shift();
                    chartData.categories.shift();
                }

                // 6. Atualiza o gr√°fico com os novos dados da m√©trica ativa
                updateChartSeries();
            } catch(e) {
                console.error('Erro:', e);
            }
        }

        function updateChartSeries() {
            var seriesName = '';
            var data = [];
            var color = '';

            switch (currentMetric) {
                case 'humidity':
                    seriesName = 'Umidade';
                    data = chartData.humidity;
                    color = '#06b6d4';
                    break;
                case 'pressure':
                    seriesName = 'Press√£o';
                    data = chartData.pressure;
                    color = '#8b5cf6';
                    break;
                default:
                    seriesName = 'Temperatura';
                    data = chartData.temp;
                    color = '#f59e0b';
                    break;
            }

            chart.updateOptions({
                xaxis: {categories: chartData.categories},
                colors: [color]
            });
            chart.updateSeries([{name: seriesName, data: data}]);
        }

        document.getElementById('chart-controls').addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                var buttons = document.querySelectorAll('.chart-btn');
                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].classList.remove('active');
                }
                e.target.classList.add('active');
                currentMetric = e.target.getAttribute('data-metric');
                updateChartSeries();
            }
        });

        setInterval(updateData, 1000);
        updateData();
    </script>
</body>
</html>
